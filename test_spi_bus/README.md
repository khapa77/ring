# SPI Bus Diagnostic Test

Этот тест проверяет корректность работы LoRa модуля и SD карты на общей SPI шине ESP32.

## Как запустить тест

### Вариант 1: Использование PlatformIO (рекомендуется)

1. Скопируйте файл `test_spi_bus.cpp` в папку `src/` вашего проекта
2. Временно закомментируйте основной код в `src/main.cpp`
3. Добавьте вызов теста в `setup()`:

```cpp
// Временно в main.cpp
void setup() {
    Serial.begin(115200);
    delay(2000);
    testSPIBus();
    while(1); // Остановить выполнение после теста
}
```

4. Скомпилируйте и загрузите прошивку:
```bash
pio run --target upload
```

5. Откройте Serial Monitor для просмотра результатов:
```bash
pio device monitor
```

### Вариант 2: Отдельный проект PlatformIO

1. Создайте новый проект PlatformIO:
```bash
pio project init --board esp32dev
```

2. Скопируйте `test_spi_bus.cpp` в папку `src/`
3. Добавьте необходимые библиотеки в `platformio.ini`:
```ini
lib_deps = 
    sandeepmistry/LoRa@^0.8.0
    arduino-libraries/SD@^1.2.4
```

4. Скомпилируйте и запустите

## Что проверяет тест

1. **Состояние пинов SPI** - проверяет начальное состояние всех пинов
2. **Инициализация SPI шины** - тестирует базовую функциональность SPI
3. **Индивидуальная работа SD карты** - проверяет чтение/запись SD карты
4. **Индивидуальная работа LoRa** - тестирует передачу данных через LoRa
5. **Совместная работа устройств** - проверяет работу обоих устройств на общей шине
6. **Быстрое переключение** - стресс-тест быстрого переключения между устройствами

## Интерпретация результатов

- **✓ Успех** - устройство работает корректно
- **✗ Ошибка** - проблема с инициализацией или работой устройства
- **Рекомендации** - предложения по устранению проблем

## Типичные проблемы и решения

### Проблема: SD карта не инициализируется
- **Решение**: Проверьте подключение, формат карты (FAT32), питание

### Проблема: LoRa не инициализируется  
- **Решение**: Проверьте антенну, питание, правильность подключения пинов

### Проблема: Конфликты на SPI шине
- **Решение**: Убедитесь, что CS пины правильно управляются (HIGH когда устройство не активно)

### Проблема: Нестабильная работа
- **Решение**: Добавьте pull-up резисторы на CS линии, проверьте стабильность питания

## После тестирования

После успешного тестирования верните оригинальный код в `main.cpp` и убедитесь, что в рабочем коде:

1. Правильно управляются CS пины (всегда держать неактивные устройства в HIGH)
2. Добавлены задержки между переключениями устройств
3. Обрабатываются ошибки инициализации
