<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Gong Scheduler</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .schedule-item {
            transition: all 0.3s ease;
        }
        .schedule-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .time-display {
            font-family: 'Courier New', monospace;
            font-size: 1.2em;
            font-weight: bold;
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-online { background-color: #28a745; }
        .status-offline { background-color: #dc3545; }
        .status-ap { background-color: #ffc107; }
    </style>
</head>
<body class="bg-light">
    <div class="container-fluid py-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <h1 class="mb-0">
                        <i class="bi bi-bell-fill text-warning"></i>
                        Gong Scheduler
                    </h1>
                    <div class="d-flex align-items-center">
                        <span class="status-indicator" id="wifiStatus"></span>
                        <span id="wifiText" class="me-3">Connecting...</span>
                        <span class="time-display" id="currentTime">--:--</span>
                    </div>
                </div>
                <hr>
            </div>
        </div>

        <!-- WiFi Configuration -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="bi bi-wifi"></i> WiFi Configuration
                        </h5>
                        <div class="row">
                            <div class="col-md-6">
                                <form id="wifiConfigForm">
                                    <div class="mb-3">
                                        <label for="wifiSSID" class="form-label">WiFi SSID</label>
                                        <input type="text" class="form-control" id="wifiSSID" placeholder="Enter WiFi network name" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="wifiPassword" class="form-label">WiFi Password</label>
                                        <input type="password" class="form-control" id="wifiPassword" placeholder="Enter WiFi password">
                                    </div>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-save"></i> Save WiFi Config
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary ms-2" onclick="resetWiFiConfig()">
                                        <i class="bi bi-arrow-clockwise"></i> Reset
                                    </button>
                                </form>
                            </div>
                            <div class="col-md-6">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h6 class="card-title">Current Status</h6>
                                        <div id="wifiStatusInfo">
                                            <p class="mb-1"><strong>SSID:</strong> <span id="currentSSID">Not configured</span></p>
                                            <p class="mb-1"><strong>Status:</strong> <span id="connectionStatus">Unknown</span></p>
                                            <p class="mb-0"><strong>Mode:</strong> <span id="wifiMode">Unknown</span></p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Control Buttons -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Quick Actions</h5>
                        <div class="d-flex gap-2 flex-wrap">
                            <button class="btn btn-primary" onclick="playGong()">
                                <i class="bi bi-play-circle"></i> Play Gong Locally
                            </button>
                            <button class="btn btn-success" onclick="playGongLoRa()">
                                <i class="bi bi-broadcast"></i> Send Gong via LoRa
                            </button>
                            <button class="btn btn-info" onclick="refreshSchedule()">
                                <i class="bi bi-arrow-clockwise"></i> Refresh Schedule
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add Schedule Form -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Add New Schedule</h5>
                        <form id="addScheduleForm" class="row g-3">
                            <div class="col-md-2">
                                <label for="hour" class="form-label">Hour</label>
                                <select class="form-select" id="hour" required>
                                    <option value="">Hour</option>
                                    <option value="0">00</option>
                                    <option value="1">01</option>
                                    <option value="2">02</option>
                                    <option value="3">03</option>
                                    <option value="4">04</option>
                                    <option value="5">05</option>
                                    <option value="6">06</option>
                                    <option value="7">07</option>
                                    <option value="8">08</option>
                                    <option value="9">09</option>
                                    <option value="10">10</option>
                                    <option value="11">11</option>
                                    <option value="12">12</option>
                                    <option value="13">13</option>
                                    <option value="14">14</option>
                                    <option value="15">15</option>
                                    <option value="16">16</option>
                                    <option value="17">17</option>
                                    <option value="18">18</option>
                                    <option value="19">19</option>
                                    <option value="20">20</option>
                                    <option value="21">21</option>
                                    <option value="22">22</option>
                                    <option value="23">23</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label for="minute" class="form-label">Minute</label>
                                <select class="form-select" id="minute" required>
                                    <option value="">Min</option>
                                    <option value="0">00</option>
                                    <option value="15">15</option>
                                    <option value="30">30</option>
                                    <option value="45">45</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="description" class="form-label">Description</label>
                                <input type="text" class="form-control" id="description" placeholder="Morning meditation" required>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">&nbsp;</label>
                                <button type="submit" class="btn btn-primary w-100">
                                    <i class="bi bi-plus-circle"></i> Add
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Schedule List -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Schedule</h5>
                        <div id="scheduleList" class="row g-3">
                            <!-- Schedule items will be populated here -->
                        </div>
                        <div id="noSchedule" class="text-center text-muted py-4" style="display: none;">
                            <i class="bi bi-calendar-x display-1"></i>
                            <p class="mt-3">No schedule entries yet. Add your first gong time above.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Schedule Modal -->
    <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Schedule</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editScheduleForm">
                        <input type="hidden" id="editId">
                        <div class="mb-3">
                            <label for="editHour" class="form-label">Hour</label>
                            <select class="form-select" id="editHour" required>
                                <!-- Options will be populated -->
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="editMinute" class="form-label">Minute</label>
                            <select class="form-select" id="editMinute" required>
                                <!-- Options will be populated -->
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="editDescription" class="form-label">Description</label>
                            <input type="text" class="form-control" id="editDescription" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveEdit()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast for notifications -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="notificationToast" class="toast" role="alert">
            <div class="toast-header">
                <strong class="me-auto">Notification</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="toastMessage">
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let scheduleData = [];
        let editModal;
        let wifiConfig = {};

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            editModal = new bootstrap.Modal(document.getElementById('editModal'));
            refreshSchedule();
            loadWiFiConfig();
            updateTime();
            setInterval(updateTime, 1000);
            setInterval(checkWiFiStatus, 5000);
        });

        // Update current time
        function updateTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('en-US', { 
                hour12: false, 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            document.getElementById('currentTime').textContent = timeString;
        }

        // Load WiFi configuration
        async function loadWiFiConfig() {
            try {
                const response = await fetch('/wifi-config');
                if (response.ok) {
                    wifiConfig = await response.json();
                    updateWiFiConfigDisplay();
                }
            } catch (error) {
                console.log('Failed to load WiFi config:', error);
            }
        }

        // Update WiFi configuration display
        function updateWiFiConfigDisplay() {
            document.getElementById('currentSSID').textContent = wifiConfig.ssid || 'Not configured';
            document.getElementById('connectionStatus').textContent = wifiConfig.connected ? 'Connected' : 'Disconnected';
            document.getElementById('wifiMode').textContent = wifiConfig.ap_mode ? 'Access Point' : 'Station';
            
            if (wifiConfig.ssid) {
                document.getElementById('wifiSSID').value = wifiConfig.ssid;
            }
        }

        // Check WiFi status
        async function checkWiFiStatus() {
            try {
                const response = await fetch('/schedule');
                const statusIndicator = document.getElementById('wifiStatus');
                const statusText = document.getElementById('wifiText');
                
                if (response.ok) {
                    statusIndicator.className = 'status-indicator status-online';
                    statusText.textContent = 'Online';
                } else {
                    statusIndicator.className = 'status-indicator status-offline';
                    statusText.textContent = 'Offline';
                }
            } catch (error) {
                const statusIndicator = document.getElementById('wifiStatus');
                const statusText = document.getElementById('wifiText');
                statusIndicator.className = 'status-indicator status-ap';
                statusText.textContent = 'AP Mode';
            }
        }

        // Refresh schedule from server
        async function refreshSchedule() {
            try {
                const response = await fetch('/schedule');
                if (response.ok) {
                    scheduleData = await response.json();
                    displaySchedule();
                } else {
                    showNotification('Failed to load schedule', 'error');
                }
            } catch (error) {
                showNotification('Network error: ' + error.message, 'error');
            }
        }

        // Display schedule in UI
        function displaySchedule() {
            const container = document.getElementById('scheduleList');
            const noSchedule = document.getElementById('noSchedule');
            
            if (scheduleData.length === 0) {
                container.style.display = 'none';
                noSchedule.style.display = 'block';
                return;
            }
            
            container.style.display = 'flex';
            noSchedule.style.display = 'none';
            
            // Sort schedule by time
            scheduleData.sort((a, b) => {
                const timeA = a.hour * 60 + a.minute;
                const timeB = b.hour * 60 + b.minute;
                return timeA - timeB;
            });
            
            container.innerHTML = scheduleData.map(item => `
                <div class="col-md-6 col-lg-4">
                    <div class="card schedule-item h-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h6 class="card-title mb-0">
                                    <i class="bi bi-clock text-primary"></i>
                                    ${String(item.hour).padStart(2, '0')}:${String(item.minute).padStart(2, '0')}
                                </h6>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" 
                                           ${item.enabled ? 'checked' : ''} 
                                           onchange="toggleSchedule(${item.id}, this.checked)">
                                </div>
                            </div>
                            <p class="card-text">${item.description}</p>
                            <div class="d-flex gap-2">
                                <button class="btn btn-sm btn-outline-primary" onclick="editSchedule(${item.id})">
                                    <i class="bi bi-pencil"></i> Edit
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteSchedule(${item.id})">
                                    <i class="bi bi-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // WiFi configuration form submission
        document.getElementById('wifiConfigForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const ssid = document.getElementById('wifiSSID').value;
            const password = document.getElementById('wifiPassword').value;
            
            try {
                const response = await fetch('/wifi-save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ssid, password })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showNotification(result.message, 'success');
                    
                    // Clear password field
                    document.getElementById('wifiPassword').value = '';
                    
                    // Wait for restart message
                    setTimeout(() => {
                        showNotification('Device is restarting... Please wait and reconnect.', 'info');
                    }, 2000);
                } else {
                    const result = await response.json();
                    showNotification(result.message || 'Failed to save WiFi configuration', 'error');
                }
            } catch (error) {
                showNotification('Network error: ' + error.message, 'error');
            }
        });

        // Reset WiFi configuration
        async function resetWiFiConfig() {
            if (!confirm('Are you sure you want to reset the WiFi configuration? This will remove all saved WiFi credentials.')) {
                return;
            }
            
            // Clear form fields
            document.getElementById('wifiSSID').value = '';
            document.getElementById('wifiPassword').value = '';
            
            // Update display
            document.getElementById('currentSSID').textContent = 'Not configured';
            document.getElementById('connectionStatus').textContent = 'Disconnected';
            document.getElementById('wifiMode').textContent = 'Access Point';
            
            showNotification('WiFi configuration reset. Device will restart in AP mode.', 'info');
        }

        // Add new schedule
        document.getElementById('addScheduleForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const hour = parseInt(document.getElementById('hour').value);
            const minute = parseInt(document.getElementById('minute').value);
            const description = document.getElementById('description').value;
            
            try {
                const response = await fetch('/schedule', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ hour, minute, description })
                });
                
                if (response.ok) {
                    showNotification('Schedule added successfully', 'success');
                    document.getElementById('addScheduleForm').reset();
                    refreshSchedule();
                } else {
                    const result = await response.json();
                    showNotification(result.message || 'Failed to add schedule', 'error');
                }
            } catch (error) {
                showNotification('Network error: ' + error.message, 'error');
            }
        });

        // Edit schedule
        function editSchedule(id) {
            const item = scheduleData.find(s => s.id === id);
            if (!item) return;
            
            document.getElementById('editId').value = item.id;
            document.getElementById('editHour').value = item.hour;
            document.getElementById('editMinute').value = item.minute;
            document.getElementById('editDescription').value = item.description;
            
            editModal.show();
        }

        // Save edit
        async function saveEdit() {
            const id = parseInt(document.getElementById('editId').value);
            const hour = parseInt(document.getElementById('editHour').value);
            const minute = parseInt(document.getElementById('editMinute').value);
            const description = document.getElementById('editDescription').value;
            
            try {
                const response = await fetch('/schedule', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id, hour, minute, description })
                });
                
                if (response.ok) {
                    showNotification('Schedule updated successfully', 'success');
                    editModal.hide();
                    refreshSchedule();
                } else {
                    const result = await response.json();
                    showNotification(result.message || 'Failed to update schedule', 'error');
                }
            } catch (error) {
                showNotification('Network error: ' + error.message, 'error');
            }
        }

        // Delete schedule
        async function deleteSchedule(id) {
            if (!confirm('Are you sure you want to delete this schedule entry?')) {
                return;
            }
            
            try {
                const response = await fetch(`/schedule?id=${id}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showNotification('Schedule deleted successfully', 'success');
                    refreshSchedule();
                } else {
                    const result = await response.json();
                    showNotification(result.message || 'Failed to delete schedule', 'error');
                }
            } catch (error) {
                showNotification('Network error: ' + error.message, 'error');
            }
        }

        // Toggle schedule enabled/disabled
        async function toggleSchedule(id, enabled) {
            // TODO: Implement enable/disable functionality
            showNotification('Enable/disable functionality coming soon', 'info');
        }

        // Play gong locally
        async function playGong() {
            try {
                const response = await fetch('/play', { method: 'POST' });
                if (response.ok) {
                    showNotification('Gong played locally', 'success');
                } else {
                    showNotification('Failed to play gong', 'error');
                }
            } catch (error) {
                showNotification('Network error: ' + error.message, 'error');
            }
        }

        // Send gong via LoRa
        async function playGongLoRa() {
            try {
                const response = await fetch('/play-lora', { method: 'POST' });
                if (response.ok) {
                    showNotification('Gong sent via LoRa', 'success');
                } else {
                    showNotification('Failed to send gong via LoRa', 'error');
                }
            } catch (error) {
                showNotification('Network error: ' + error.message, 'error');
            }
        }

        // Show notification toast
        function showNotification(message, type = 'info') {
            const toast = document.getElementById('notificationToast');
            const toastMessage = document.getElementById('toastMessage');
            
            toastMessage.textContent = message;
            toast.classList.remove('bg-success', 'bg-danger', 'bg-info');
            
            switch (type) {
                case 'success':
                    toast.classList.add('bg-success', 'text-white');
                    break;
                case 'error':
                    toast.classList.add('bg-danger', 'text-white');
                    break;
                default:
                    toast.classList.add('bg-info', 'text-white');
            }
            
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
        }

        // Populate hour and minute options for edit form
        function populateTimeOptions() {
            const hourSelect = document.getElementById('editHour');
            const minuteSelect = document.getElementById('editMinute');
            
            // Populate hours
            for (let i = 0; i < 24; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = String(i).padStart(2, '0');
                hourSelect.appendChild(option);
            }
            
            // Populate minutes
            [0, 15, 30, 45].forEach(min => {
                const option = document.createElement('option');
                option.value = min;
                option.textContent = String(min).padStart(2, '0');
                minuteSelect.appendChild(option);
            });
        }

        // Initialize time options
        populateTimeOptions();
    </script>
</body>
</html>
