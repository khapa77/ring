# Карта пинов ESP32

## 1) LoRa SX1278 (SPI + IRQ)

### SPI (VSPI)
- **SCK**: GPIO18
- **MISO**: GPIO19  
- **MOSI**: GPIO23
- **NSS / CS**: GPIO16 ← отдельный CS на безопасном пине (не strapping)

### Управление и прерывания
- **RESET**: GPIO17 (выход)
- **DIO0**: GPIO34 (вход, прерывания OK)
- **DIO1**: GPIO35 (вход, прерывания OK) 
- **DIO2**: GPIO39 (вход, прерывания OK)
- **(опционально) DIO3**: GPIO36 (вход, если нужно)

**Заметка**: GPIO34/35/36/39 — входы-только, идеально для DIO. Подтяжки — внешними резисторами при необходимости.

---

## 2) SD-Reader (режим SPI, отдельная шина HSPI)

### SPI (HSPI, с ремапом на безопасные пины)
- **SCK**: GPIO14
- **MISO**: GPIO32  
- **MOSI**: GPIO13
- **CS**: GPIO21

### Служебные
- **Card Detect (CD)**: GPIO36 (вход; если уже занят DIO3 — можно поменять местами с ним)
- **Power Enable** (через транзистор/PMOS): GPIO27 (выход, активный уровень по вашей схеме)

**Почему SPI, а не SDMMC 4-бит**: SDMMC быстрее, но задействует «стреппинговые» пины (GPIO2/4/12/13/14/15) и может осложнить загрузку. В SPI мы изолируемся от этого и не конфликтуем с LoRa (разные SPI-контроллеры).

---

## 3) MAX98357A (I2S DAC/усилитель)

### I2S
- **BCLK**: GPIO26
- **LRCLK / WS**: GPIO25  
- **DIN (SDOUT от ESP32)**: GPIO22

### Управление
- **SD (shutdown, активный низ)**: GPIO33 (выход; подтяжка к VCC, если нужно поведение по умолчанию «вкл/выкл»)

**Эти пины** — «классическая» и надёжная связка для I2S на ESP32. 25/26 — под такт/строб, 22 — под данные.

---

## 4) UART и резерв

- **UART0 для прошивки/лога**: GPIO1 (TX0), GPIO3 (RX0) — не использовать под другое.
- **Зарезервированные/встроенная флеш**: GPIO6–11 — не трогаем.

### Свободные общие GPIO
- **GPIO4, 5, 12, 15** — лучше не использовать (стреппинг), если только вы не уверены в подтяжках и поведении при старте.
- **Остальные свободные**: при текущем планировании остаются, например:
  - GPIO2 (тоже стреппинг — избегаем)
  - GPIO0 (стреппинг — избегаем)

**Для дополнительных датчиков** лучше смотреть на GPIO5/4/15/12 только если чётко понимаете подтяжки на вашей плате.

---

## Быстрая проверка конфликтов

- **SPI разделены**:
  - LoRa сидит на VSPI (18/19/23) + CS=16
  - SD сидит на HSPI (14/32/13) + CS=21
  → Нет совместного использования линий такт/данных, CS раздельные.

- **I2S отдельный**: 25/26/22 — нигде больше не используются.

- **Прерывания LoRa**: на 34/35/39 (input-only) — корректно.

- **Старт/загрузка ESP32 не ломаем**: «опасные» пины для бутстрэппинга не задействуем под сигналы, которые могут потянуть уровень в момент старта.

---

## Электрические и схемотехнические заметки (важно)

### Подтяжки DIO SX1278
Если линии «плавают» при старте — добавьте слабые подтяжки (100k–470k) к нужным уровням на DIO/RESET согласно логике вашего стека.

### MAX98357A SD (shutdown)
Обычно держат подтянутым к VCC через 100k (вкл по умолчанию) и уже MCU опускает в «0» для отключения — или наоборот, как нужно.

### Card Detect
Большинство разъёмов — «активный низ». Поставьте подтяжку (внешнюю/внутреннюю) и учтите логику в коде.

### SD Power
Если питание SD коммутируется, не забудьте задержку 5–20 мс после включения перед инициализацией шины.

### Общие земли и длинные трассы
- У LoRa — отдельный опорный полигон под RF-часть
- Короткая связь к SMA/антенне
- Согласование по даташиту (π-цепочка, при необходимости)

### Уровни сигналов
Всё 3.3 В (SX1278/SD/MAX98357A совместимы). Разделите аналоговое питание MAX98357A (фильтрация LC) от «шумной» цифровой части по возможности.

### EMI/шумы I2S vs RF
Разводить так, чтобы I2S-такт не образовывал «антенну» в полосе работы LoRa; по возможности — внутренние слои, сплошной GND, развязка.
